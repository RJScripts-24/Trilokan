version: '3.8'

# ========================================
# Development Docker Compose Configuration
# ========================================
# This file provides a reproducible development environment
# with proper service isolation, networking, and volumes.
#
# Usage:
#   docker-compose -f docker-compose.dev.yml up
#   docker-compose -f docker-compose.dev.yml down
#
# Prerequisites:
#   - Copy .env.example to .env and configure
#   - Ensure ports 3000, 5000, 5001, 5002, 5432 are available

services:
  # ========================================
  # Complaint ML Service
  # ========================================
  complaint-ml:
    build:
      context: ./ml-services/complaint
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=development
    container_name: trilokan-complaint-ml-dev
    environment:
      PORT: 5000
      X_API_KEY: ${ML_COMPLAINT_API_KEY:-dev-api-key-complaint-service}
      FLASK_ENV: development
      FLASK_DEBUG: 1
    ports:
      - "5000:5000"
    volumes:
      - ./ml-services/complaint:/app
      - complaint_dev_uploads:/app/temp_uploads
      - complaint_dev_models:/app/models
    networks:
      - trilokan-dev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ========================================
  # App Crawler Service
  # ========================================
  app-crawler:
    build:
      context: ./ml-services/app-crawler
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=development
    container_name: trilokan-app-crawler-dev
    environment:
      PORT: 5001
      X_API_KEY: ${ML_APP_CRAWLER_API_KEY:-dev-api-key-app-crawler}
      FLASK_ENV: development
      FLASK_DEBUG: 1
    ports:
      - "5001:5001"
    volumes:
      - ./ml-services/app-crawler:/app
      - app_dev_uploads:/app/uploads
      - app_dev_apks:/app/reference_apks
    networks:
      - trilokan-dev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ========================================
  # Identity Verifier Service
  # ========================================
  identity-verifier:
    build:
      context: ./ml-services/identity-verifier
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=development
    container_name: trilokan-identity-verifier-dev
    environment:
      PORT: 5002
      X_API_KEY: ${ML_IDENTITY_API_KEY:-dev-api-key-identity-verifier}
      FLASK_ENV: development
      FLASK_DEBUG: 1
    ports:
      - "5002:5002"
    volumes:
      - ./ml-services/identity-verifier:/app
      - identity_dev_uploads:/app/temp_uploads
      - identity_dev_models:/app/models
    networks:
      - trilokan-dev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ========================================
  # API Gateway
  # ========================================
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
      target: development
    container_name: trilokan-api-gateway-dev
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-3000}
      
      # JWT
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-this}
      JWT_ACCESS_EXPIRATION_MINUTES: ${JWT_ACCESS_EXPIRATION_MINUTES:-30}
      JWT_REFRESH_EXPIRATION_DAYS: ${JWT_REFRESH_EXPIRATION_DAYS:-30}
      
      # ML Services (using Docker service names)
      ML_COMPLAINT_URL: http://complaint-ml:5000
      ML_COMPLAINT_API_KEY: ${ML_COMPLAINT_API_KEY:-dev-api-key-complaint-service}
      ML_IDENTITY_URL: http://identity-verifier:5002
      ML_IDENTITY_API_KEY: ${ML_IDENTITY_API_KEY:-dev-api-key-identity-verifier}
      ML_APP_CRAWLER_URL: http://app-crawler:5001
      ML_APP_CRAWLER_API_KEY: ${ML_APP_CRAWLER_API_KEY:-dev-api-key-app-crawler}
      
      # Email (optional)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@trilokan.gov.in}
    ports:
      - "${PORT:-3000}:3000"
    volumes:
      # Mount source for hot-reload
      - ./api-gateway:/app
      - /app/node_modules
      - gateway_dev_uploads:/app/uploads
      - gateway_dev_logs:/app/logs
    networks:
      - trilokan-dev-network
    depends_on:
      complaint-ml:
        condition: service_healthy
      app-crawler:
        condition: service_healthy
      identity-verifier:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    command: npm run dev

  # ========================================
  # Prometheus (Monitoring)
  # ========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: trilokan-prometheus-dev
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_dev_data:/prometheus
    networks:
      - trilokan-dev-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    restart: unless-stopped

  # ========================================
  # Grafana (Visualization)
  # ========================================
  grafana:
    image: grafana/grafana:latest
    container_name: trilokan-grafana-dev
    ports:
      - "3001:3000"
    volumes:
      - grafana_dev_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    networks:
      - trilokan-dev-network
    depends_on:
      - prometheus
    restart: unless-stopped

# ========================================
# Named Volumes
# ========================================
volumes:
  complaint_dev_uploads:
    name: trilokan-complaint-uploads-dev
  complaint_dev_models:
    name: trilokan-complaint-models-dev
  app_dev_uploads:
    name: trilokan-app-uploads-dev
  app_dev_apks:
    name: trilokan-app-apks-dev
  identity_dev_uploads:
    name: trilokan-identity-uploads-dev
  identity_dev_models:
    name: trilokan-identity-models-dev
  gateway_dev_uploads:
    name: trilokan-gateway-uploads-dev
  gateway_dev_logs:
    name: trilokan-gateway-logs-dev
  prometheus_dev_data:
    name: trilokan-prometheus-dev-data
  grafana_dev_data:
    name: trilokan-grafana-dev-data

# ========================================
# Networks
# ========================================
networks:
  trilokan-dev-network:
    name: trilokan-dev-network
    driver: bridge
